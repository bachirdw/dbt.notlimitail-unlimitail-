# Fichier : dbt_notlimitail_tl/models/marts/fct_campaign_performance.yml

version: 2

models:
  - name: fct_campaign_performance
    description: "TABLE DE FAITS : Modèle principal qui agrège les coûts marketing et les revenus des ventes par jour et par nom de campagne. C'est la source de vérité pour l'analyse de la performance."
    
    columns:
      # --- DIMENSIONS (Axes d'analyse) ---
      - name: event_date
        description: "AXE TEMPOREL : Le jour où les dépenses marketing ont eu lieu."
        tests:
          - not_null

      - name: campaign_name
        description: "AXE CAMPAGNE : Le nom de la campagne publicitaire."
        tests:
          - not_null
          # On vérifie que le nom de la campagne existe dans notre table de dimension
          - relationships:
              to: ref('mt_dim_campaigns')
              field: campaign_name

      # --- MESURES (Indicateurs de performance) ---
      - name: total_cost
        description: "MESURE MARKETING : Coût total des clics pour cette campagne ce jour-là."
        meta:
          measures:
            daily_total_cost:
              type: sum
              description: "Coût total des clics pour cette campagne ce jour-là."
              value_format_name: usd

      - name: total_clicks
        description: "MESURE MARKETING : Nombre total de clics enregistrés pour cette campagne ce jour-là."
        meta:
          measures:
            daily_total_clicks:
              type: sum
              description: "Nombre total de clics enregistrés pour cette campagne ce jour-là."

      - name: total_revenue
        description: "MESURE DE VENTE : Revenu total généré par les ventes ce jour-là."
        meta:
          measures:
            daily_total_revenue:
              type: sum
              description: "Revenu total généré par les ventes ce jour-là."
              value_format_name: usd

      - name: total_orders
        description: "MESURE DE VENTE : Nombre total de commandes uniques passées ce jour-là."
        meta:
          measures:
            daily_total_orders:
              type: sum
              description: "Nombre total de commandes uniques passées ce jour-là."
    
    # --- DÉFINITION DES JOINTURES POUR LOOKER ---
    meta:
      joins:
        # Jointure avec la dimension des campagnes
        - join: mt_dim_campaigns
          sql_on: "${fct_campaign_performance.campaign_name} = ${mt_dim_campaigns.campaign_name}"
          relationship: many_to_one

          # NOUVELLE JOINTURE : Jointure avec la dimension de date
        - join: dim_time_spine
          sql_on: "${fct_campaign_performance.event_date} = ${dim_time_spine.date_day}"
          relationship: many_to_one